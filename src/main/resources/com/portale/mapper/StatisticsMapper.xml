<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portale.mapper.StatisticsMapper">

	<select id="GetWSV_TopStores" resultMap="VisitStatusMLResultMap">
		select s.store_name as el_name, wvs_today, wvs_all, wvs_obj_id as el_id from webstatistics_visits_short
inner join (
select store_id, store_name 
from store
)s on s.store_id = wvs_obj_id
order by wvs_all desc, wvs_today desc, store_name asc
limit 10
	</select>
	
	<select id="GetWSV_TopProd" resultMap="VisitStatusMLResultMap">
	select p.item_name as el_name, wvs_today, wvs_all, wvs_obj_id as el_id from webstatistics_visits_short
inner join (
select item_id, item_name 
from storage_items
)p on p.item_id = wvs_obj_id
order by wvs_all desc, wvs_today desc, item_name asc
limit 10
	</select>
	
	<select id="GetWSV_TopStorages" resultMap="VisitStatusMLResultMap">
	select s.storage_name as el_name, wvs_today, wvs_all, wvs_obj_id as el_id from webstatistics_visits_short
inner join (
select storage_id, storage_name 
from storage
inner join (select store_id from store where store_depth != 0)x on x.store_id = store_ref
)s on s.storage_id = wvs_obj_id
order by wvs_all desc, wvs_today desc, storage_name asc
limit 10
</select>
	
	<resultMap id="VisitStatusMLResultMap" type="StatisticDetailsObj">
		<result property="wvs_today" column="wvs_today" />
		<result property="wvs_all" column="wvs_all" />
		<result property="wvs_obj_name" column="el_name" />
		<result property="wvs_obj_id" column="el_id" />
	</resultMap>
	
	<select id="GetVisitStatus" resultMap="VisitStatusResultMap">
		select webstats.* 
		from webstatistics_visits webstats
	</select>
	<resultMap id="VisitStatusResultMap" type="Statistics_Views">
		<id property="statistic_id" column="id_view" />
		<result property="ip_address" column="ipaddress" />
		<result property="msdatetime" column="datetime" />
	</resultMap>
	
	<insert id="AddWebSiteVisit">
		insert into webstatistics_visits(ipaddress, datetime, wv_obj_id, wv_details)
		values (#{host},#{datetime}, #{wv_obj_id}, #{wv_details})
		
	</insert>
	
	<resultMap id="wvs_prod" type="StatisticDetailsObj">
		<result property="wvs_today" column="today" />
		<result property="wvs_all" column="all" />
	</resultMap>
	
	<select id="GetWSV_Prod" resultMap="wvs_prod">
		SELECT wvs_today as today, wvs_all as all
		FROM webstatistics_visits_short
		WHERE wvs_obj_id = #{wvs_obj_id} AND wvs_details = #{wvs_details}
	</select>
	
	<insert id="CreateWSV_Prod">
		insert into webstatistics_visits_short (wvs_obj_id, wvs_details)
		values (#{wvs_obj_id}, #{wvs_details})
	</insert>
	
	<update id="AddWSV_Prod">
		update webstatistics_visits_short
		set 
		wvs_today = CASE WHEN (SELECT (CURRENT_DATE::date - (SELECT wvs_date FROM webstatistics_visits_short WHERE wvs_obj_id = #{wvs_obj_id} AND wvs_details = #{wvs_details})::date) AS days) >= 1 THEN 1
		ELSE wvs_today + 1
		END,
		wvs_all = wvs_all + 1,
		wvs_date =  CASE WHEN (SELECT (CURRENT_DATE::date - (SELECT wvs_date FROM webstatistics_visits_short WHERE wvs_obj_id = #{wvs_obj_id} AND wvs_details = #{wvs_details})::date) AS days) >= 1 THEN CURRENT_DATE
		ELSE wvs_date
		END
		WHERE wvs_obj_id = #{wvs_obj_id} AND wvs_details = #{wvs_details}
	</update>
	
	<delete id="DeleteWSV_Prod">
		DELETE FROM webstatistics_visits_short
		WHERE wvs_obj_id = #{wvs_obj_id} AND wvs_details = #{wvs_details}
	</delete>
</mapper>